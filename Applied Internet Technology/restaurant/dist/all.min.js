var passport=require("passport"),express=require("express"),path=require("path"),favicon=require("serve-favicon"),logger=require("morgan"),cookieParser=require("cookie-parser"),bodyParser=require("body-parser"),session=require("express-session"),routes=require("./routes/index"),users=require("./routes/users"),app=express();app.set("views",path.join(__dirname,"views")),app.set("view engine","hbs"),app.use(logger("dev")),app.use(bodyParser.json()),app.use(bodyParser.urlencoded({extended:!1})),app.use(cookieParser()),app.use(express["static"](path.join(__dirname,"public")));var sessionOptions={secret:"secret cookie thang (store this elsewhere!)",resave:!0,saveUninitialized:!0};app.use(session(sessionOptions)),app.use(passport.initialize()),app.use(passport.session()),app.use(function(e,r,s){r.locals.user=e.user,s()}),app.use("/",routes),app.use("/users",users),app.use(function(e,r,s){var o=new Error("Not Found");o.status=404,s(o)}),"development"===app.get("env")&&app.use(function(e,r,s,o){s.status(e.status||500),s.render("error",{message:e.message,error:e})}),app.use(function(e,r,s,o){s.status(e.status||500),s.render("error",{message:e.message,error:{}})}),module.exports=app;var mongoose=require("mongoose"),passport=require("passport"),LocalStrategy=require("passport-local").Strategy,User=mongoose.model("User");passport.use(new LocalStrategy(User.authenticate())),passport.serializeUser(User.serializeUser()),passport.deserializeUser(User.deserializeUser());var mongoose=require("mongoose"),URLSlugs=require("mongoose-url-slugs"),passportLocalMongoose=require("passport-local-mongoose"),UserSchema=new mongoose.Schema({});UserSchema.plugin(passportLocalMongoose);var Schema=mongoose.Schema,itemSchema=new Schema({name:String,vegetarian:Boolean,vegan:Boolean,price:Number,type:String}),mealList=new Schema({name:String,hours:String,items:[itemSchema]}),reviewSchema=new Schema({review:String,rating:Number,username:String});mealList.plugin(URLSlugs("name")),itemSchema.plugin(URLSlugs("type name")),reviewSchema.plugin(URLSlugs("review")),mongoose.model("mealList",mealList),mongoose.model("itemSchema",itemSchema),mongoose.model("reviewSchema",reviewSchema),mongoose.model("User",UserSchema),mongoose.connect("mongodb://localhost:10321/restaurant");var gulp=require("gulp"),jshint=require("gulp-jshint"),concat=require("gulp-concat"),uglify=require("gulp-uglify"),rename=require("gulp-rename"),less=require("gulp-less");gulp.task("lint",function(){return gulp.src(["*.js","routes/*.js"]).pipe(jshint()).pipe(jshint.reporter("default"))}),gulp.task("less",function(){return gulp.src("./less/*.less").pipe(less()).pipe(gulp.dest("./public/stylesheets"))}),gulp.task("scripts",function(){return gulp.src(["*.js","routes/*.js"]).pipe(concat("all.js")).pipe(gulp.dest("dist")).pipe(rename("all.min.js")).pipe(uglify()).pipe(gulp.dest("dist"))}),gulp.task("watch",function(){gulp.watch(["*.js","routes/*.js"],["lint","scripts"]),gulp.watch("less/*.less",["less"])}),gulp.task("default",["lint","less","scripts","watch"]);var express=require("express"),router=express.Router(),passport=require("passport"),mongoose=require("mongoose");require("../db"),require("../auth");var mealList=mongoose.model("mealList"),itemSchema=mongoose.model("itemSchema"),reviewSchema=mongoose.model("reviewSchema"),User=mongoose.model("User");router.get("/",function(e,r,s){r.render("index",{title:"Xaria's Restaurant"})}),router.get("/meals",function(e,r){mealList.find(function(e,s,o){console.log(e,s,o),r.render("meals",{heading3:"Menus",mealList:s})})}),router.get("/meals/:slug",function(e,r,s){var o=!1;"undefined"!=typeof e.user&&"xaria"==e.user.username&&(o=!0);var t=e.params.slug,a=t.replace(/\w\S*/g,function(e){return t.charAt(0).toUpperCase()+t.substr(1).toLowerCase()});mealList.findOne({name:a},function(e,s,t){console.log("meal name!",a,e,s,t);var n;if(null!==s){var i=s.items;n=i.sort(function(e,r){return e.type>r.type?1:e.type<r.type?-1:0})}r.render("menu",{heading3:a,itemList:n,administrator:o})})}),router.post("/item/create",function(e,r){console.log("creating",e.body.name);var s=new itemSchema({name:e.body.name,vegetarian:e.body.vegetarian,vegan:e.body.vegan,price:e.body.price,type:e.body.type});s.save(function(r,o,t){console.log("made me a item",s.name,t,r),r||mealList.findOneAndUpdate({name:e.body.mealName},{$push:{items:s}},{safe:!0,upsert:!0},function(e,r){e&&console.log("error",e)})}),console.log("mealname",e.body.mealName),r.redirect("/meals/"+e.body.mealName)}),router.get("/reviews",function(e,r,s){reviewSchema.find(function(e,s,o){console.log(e,s,o),r.render("reviews",{heading3:"Reviews",reviews:s})})}),router.post("/reviews/create",function(e,r,s){var o=new reviewSchema({review:e.body.review,rating:e.body.rating,username:e.body.username});o.save(function(e,r,s){console.log("made me a review",o.review,s,e),e||console.log("review create",o.review)}),r.redirect("/reviews")}),router.get("/about",function(e,r,s){r.render("about",{heading3:"About"})}),router.get("/gallery",function(e,r,s){r.render("gallery",{heading3:"Gallery"})}),router.get("/register",function(e,r){r.render("register")}),router.post("/register",function(e,r){User.register(new User({username:e.body.username}),e.body.password,function(s,o){s?r.render("register",{message:"Your registration information is not valid"}):passport.authenticate("local")(e,r,function(){r.redirect("/")})})}),router.get("/login",function(e,r){r.render("login")}),router.post("/login",function(e,r,s){passport.authenticate("local",function(s,o){o?(passport.serializeUser(function(e,r){r(null,e.id)}),e.logIn(o,function(e){r.redirect("/")})):r.render("login",{message:"Your login or password is incorrect."})})(e,r,s)}),router.get("/logout",function(e,r){e.logout(),r.redirect("/")}),module.exports=router;var express=require("express"),router=express.Router();router.get("/",function(e,r,s){r.send("respond with a resource")}),module.exports=router;